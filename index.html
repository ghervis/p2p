<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>P2P Chat</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/peerjs/1.5.4/peerjs.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        input, textarea { width: 100%; margin-bottom: 10px; }
        button { padding: 10px; }
        #chat { border: 1px solid #ccc; height: 300px; overflow-y: scroll; padding: 10px; margin-bottom: 10px; }
    </style>
</head>
<body>
    <h1>Simple P2P Chat</h1>
    <div id="status">Enter room code and choose to create or join.</div>
    <input type="text" id="roomCode" placeholder="Room Code">
    <button id="createRoom">Create Room</button>
    <button id="joinRoom">Join Room</button>
    <div id="chat" style="display:none;"></div>
    <input type="text" id="messageInput" placeholder="Type your message..." style="display:none;">
    <button id="sendButton" style="display:none;">Send</button>
    <script>
        let peer;
        let connections = [];
        let isHost = false;

        const statusDiv = document.getElementById('status');
        const roomCodeInput = document.getElementById('roomCode');
        const createRoomButton = document.getElementById('createRoom');
        const joinRoomButton = document.getElementById('joinRoom');
        const chat = document.getElementById('chat');
        const messageInput = document.getElementById('messageInput');
        const sendButton = document.getElementById('sendButton');

        function generateId() {
            return Math.random().toString(36).substr(2, 9);
        }

        createRoomButton.onclick = () => {
            console.log('Creating peer...');
            peer = new Peer(generateId(), {host: 'rendon-smig.onrender.com', path: '/signaling', secure: true});
            peer.on('open', (id) => {
                console.log('Peer open with id:', id);
                roomCodeInput.value = id;
                statusDiv.textContent = 'Room created. Share the code: ' + id;
                isHost = true;
            });
            peer.on('error', (err) => {
                console.log('Peer error:', err);
                statusDiv.textContent = 'Error creating room: ' + err.message;
            });
            peer.on('connection', (conn) => {
                console.log('Incoming connection');
                connections.push(conn);
                conn.on('open', () => {
                    console.log('Connection open');
                    statusDiv.textContent = 'Peer connected. Total peers: ' + connections.length;
                    enableChat();
                });
                conn.on('close', () => {
                    console.log('Connection closed');
                    statusDiv.textContent = 'Peer disconnected.';
                });
                conn.on('data', (data) => {
                    console.log('Received data:', data);
                    displayMessage('Remote: ' + data);
                    // Broadcast to others
                    connections.forEach(c => {
                        if (c !== conn) c.send(data);
                    });
                });
            });
        };

        joinRoomButton.onclick = () => {
            const code = roomCodeInput.value;
            if (!code) {
                statusDiv.textContent = 'Enter a room code.';
                return;
            }
            console.log('Joining room:', code);
            peer = new Peer(null, {host: 'rendon-smig.onrender.com', path: '/signaling', secure: true});
            peer.on('error', (err) => {
                console.log('Peer error:', err);
                statusDiv.textContent = 'Error initializing peer: ' + err.message;
            });
            const conn = peer.connect(code);
            console.log('Connecting to:', code);
            conn.on('open', () => {
                console.log('Connection open');
                statusDiv.textContent = 'Connected to room.';
                connections.push(conn);
                enableChat();
            });
            conn.on('close', () => {
                console.log('Connection closed');
                statusDiv.textContent = 'Connection closed.';
            });
            conn.on('error', (err) => {
                console.log('Connection error:', err);
                statusDiv.textContent = 'Error joining room: ' + err.message;
            });
            conn.on('data', (data) => {
                console.log('Received data:', data);
                displayMessage('Remote: ' + data);
            });
        };

        function enableChat() {
            sendButton.disabled = false;
            sendButton.style.display = 'inline';
            messageInput.style.display = 'inline';
            chat.style.display = 'block';
            createRoomButton.style.display = 'none';
            joinRoomButton.style.display = 'none';
            roomCodeInput.style.display = 'none';
        }

        sendButton.onclick = () => {
            const message = messageInput.value;
            if (message && connections.length > 0) {
                connections.forEach(c => c.send(message));
                displayMessage('You: ' + message);
                messageInput.value = '';
            }
        };

        function displayMessage(msg) {
            const p = document.createElement('p');
            p.textContent = msg;
            chat.appendChild(p);
            chat.scrollTop = chat.scrollHeight;
        }

        sendButton.disabled = true;
    </script>
</body>
</html>